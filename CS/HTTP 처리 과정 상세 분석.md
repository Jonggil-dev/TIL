# HTTP 처리 과정 상세 분석

### **1. 순서 요약**

1. **TCP 연결 설정 (3-way handshake)**: 클라이언트- 서버는 TCP의 3-way handshake를 통해 연결을 설정 (SYN, SYN-ACK, ACK)

2. **HTTP 요청 전송**: 클라이언트는 HTTP 요청을 작성하고, 이를 TCP/IP 프로토콜을 통해 여러 개의 패킷으로 나누어 서버로 전송

3. **서버의 운영체제에서 패킷 수신 및 재조립**: 운영체제 레벨에서 수신된 패킷을 순서대로 재조립하여 완전한 HTTP 요청 메시지를 복원

4. **★운영체제 레벨에서 재조립된 HTTP 요청을 Spring 서버(WAS)에서 받아들임★**

   - **Header (Request Line 포함)는 메모리에 로드되고, Body(또는 Payload)는 스트림(Stream) 방식으로 처리**

     - **Body는 스트림으로 처리 되기 때문에 한 번 읽으면 소모되므로 다시 읽을 수 없음**
     - **즉, 예시로 아래의 `HttpServletRequest`를 통해 Filter에서 Stream으로 Body에 접근하면, 컨트롤러에서는 @RequestBody로 빈 내용밖에 안 읽어짐**
     - **Body의 재사용이 필요한 경우 처음 Body를 조회하는 곳에서 캐싱을 하여 이후에 재사용이 가능하도록 처리 해야함**

     

   - **WAS는 HTTP 요청 정보를 담은 `HttpServletRequest` 객체를 생성**

     - **`HttpServletRequest`는 쉽게 Spring 코드에서 HTTP 요청의 모든 정보에 접근할 수 있도록 하는 객체.** 
     - 이를 통해 Spring 애플리케이션은 HTTP 요청에 포함된 데이터를 손쉽게 사용할 수 있음

     

5. **응답 생성 및 반환**:

   - Spring에서 request Body를 InputStream을 통해 순차적으로 읽어들이며, 필요한 로직 수행
   - 응답은 다시 WAS를 통해 클라이언트에게 전송

---



### 2. 참고

#### 2.1 HTTP 요청의 구조 (헤더와 바디)

- **Request Line (요청 라인)**: HTTP 요청의 첫 번째 줄로, HTTP 메서드, URI, HTTP 버전 정보를 포함
- **Header (헤더)**: 
  - Request Line 다음에 오는 메타데이터로 HTTP 요청에 대한 추가적인 정보를 제공
  - 각 헤더는 키-값 쌍으로 이루어져 있음 : `Host`, `Content-Type`, `User-Agent`, `Authorization` 등 

- **Body (본문)**:
  - 본문은 요청의 실제 데이터를 포함 :JSON, XML, 폼 데이터 등

#### 2.2 데이터의 패킷화와 전송

- 클라이언트는 HTTP 요청을 작성한 후, TCP/IP 프로토콜에 의해 데이터를 여러 개의 패킷으로 나누어 전송
- **각 패킷은 순번이 부여되어 있으며, 네트워크를 통해 서버로 전송됩니다.**



#### 2.3 패킷의 순서 보장과 재조립 과정

- **패킷 순서 보장**: TCP는 패킷의 순서를 추적하고, 누락된 패킷이 있을 경우 재전송을 요청합니다.
- **재조립**: 모든 패킷이 도착하면, 순번에 따라 데이터를 조합하여 **완전한 HTTP 요청 메시지**를 복원합니다.
- 이 단계는 운영체제 레벨에서 처리되며, 애플리케이션 레벨에서는 완전한 데이터를 전달받게 됩니다.



#### 2.4 WAS에서의 스트림 처리

- **운영체제 레벨에서 재조립된 HTTP 요청을 WAS에서 읽어들임**
  - WAS는Request Line은 HTTP 요청의 첫 줄로,  이를 가장 먼저 파싱하여 HTTP 메서드, URI, HTTP 버전 정보를 추출
  - Request Line이 처리된 후 나머지 헤더와 본문(Body)을 처리
  - Request Line, Header는 메모리에 로드되고, Body는 스트림으로 처리됩니다.
- **InputStream(Request Body)의 특성**:
  - **Body는 한 번 읽으면 데이터를 다시 읽을 수 없음(필요 시 캐싱 사용)** 
    -> 스트림은 데이터를 소비하면서 진행되기 때문에 한 번 읽으면 그 데이터를 다시 읽을 수 없음

> **스트림(Stream)** : 데이터를 순차적으로 처리하기 위한 방식으로, 메모리에 모든 데이터를 한꺼번에 올리지 않고 필요한 만큼씩 읽어서 처리하는 방식

