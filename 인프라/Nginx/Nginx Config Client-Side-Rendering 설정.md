# Nginx Config Client-Side-Rendering 설정

### 문제

- react에서 Route를 사용한 주소에 대해서 url을 직접 입력하면 페이지가 출력되지 않고 404 에러가 뜸

### 원인

- React 같은 현대적인 기술을 사용한 웹 앱 처럼 **SPA는 사용자가 다른 페이지로 이동하더라도 서버에서 새로운 HTML을 받아오는 것이 아니라, JavaScript가 현재 페이지를 적절히 변경해서 우리 눈에는 마치 새로운 페이지로 이동한 것처럼 보이게 하는 거임**
- 쉽게, Route를 사용해서 매핑한 주소는 index.html 안에서 그냥 이루어진다고 생각하면 이해됨 (해당 주소에 대해 서버에 새로운 요청을 보내는게 아님). React 내부적으로 해당 url에 대해서 어떻게 출력할 건지 결정해놓은거임

- 문제는, 사용자가 웹 브라우저의 주소 창에 직접 특정 URL을 입력해서 접속하거나 새로고침을 할 때 생김. SPA에서는 서버에 해당 경로의 HTML 파일이 실제로 존재하지 않기 때문에 404 에러가 뜸.

- 결국, NGINX에게 "어떤 경로로 요청이 들어오든 간에, 항상 같은 `index.html`을 반환하도록 하면, React 앱이 알아서 페이지를 적절히 보여줄 거야"라고 설정할 수 있음. 이렇게 하면, 사용자가 웹 앱의 어떤 URL로 직접 접속하더라도 항상 `index.html`이 정상적으로 로드되고, `index.html` 내부의 라우팅 로직이 그 요청을 처리하여 올바른 페이지를 보여줄 수 있게 됨

### 해결 방법 (`try_files` 지시어 사용)

- `try_files $uri $uri/ /index.html;` :  Nginx가 요청에 대응하는 파일이나 디렉토리를 찾지 못했을 때 기본적으로 제공할 파일을 지정
  - `$uri`: 요청된 URI를 나타냅니다. 예를 들어, `https://domain.com/about` 요청이 들어오면, `$uri`는 `/about`
  - `$uri/`: 요청된 URI가 디렉토리를 가리킬 경우를 나타냄. 즉, 요청이 디렉토리에 대한 것이라고 가정하고, 해당 디렉토리 내에서 `index` 지시어에 의해 정의된 기본 파일(예: `index.html`)을 찾음
  - `/index.html`: 이 부분은 Nginx에게 위에서 지정한 파일이나 디렉토리를 찾을 수 없을 경우 사용할 기본 파일을 알려줌. 즉, 모든 검색이 실패했을 때 마지막으로 시도할 파일 경로

- **동작 과정**

1. **첫 번째로 `$uri`를 확인**: Nginx는 요청된 URI에 해당하는 파일이 `root` 지시어에 의해 정의된 디렉토리 내에 존재하는지 확인. 만약 파일이 존재한다면, 그 파일을 클라이언트에게 제공하고 처리 과정을 종료
2. **두 번째로 `$uri/`를 확인**: 만약 첫 번째 단계에서 파일을 찾지 못했다면, Nginx는 요청된 URI가 디렉토리를 가리키는지 확인. 디렉토리가 존재하고, `index` 지시어에 의해 정의된 기본 파일(예: `index.html`)이 그 디렉토리 안에 있다면, 그 파일을 제공
3. **세 번째로 `/index.html`를 제공**: 위의 두 단계를 통해 요청을 처리할 수 없는 경우, Nginx는 마지막으로 `/index.html` 파일을 제공. `/index.html`은 Nginx 설정의 `root` 지시어에 지정된 디렉토리 안에 위치한 `index.html` 파일을 가리킴. 클라이언트 사이드 라우팅을 사용하는 애플리케이션에서는 서버에 실제 파일이나 디렉토리가 존재하지 않더라도, 모든 요청을 `index.html`로 리디렉션하여 JavaScript가 라우팅을 처리할 수 있도록 함