# 특화 프로젝트 에러정리

### 1. spirng application.properties 에러

- 상황
  - 민감한 정보를 숨기기 위해 별도의 프로파일(ex.application-{profile}.properties)을 만들고 .gitignore에 포함해 민감 정보를 사용함
  - 하지만 해당 파일이 gitlab에 올라가지 않으면서 jenkins 자동 배포 - 소스코드 빌드 중 환경변수로 사용한 변수에 대해 접근할 수 없는 에러 발생
  - Jenkins Credentials에 application-{profile}.properties 파일을 등록하고 jenkinsfile에서 소스코드 빌드 전 필요한 경로에 해당 파일을 복사해서 빌드를 수행하면 해결됨
  - 그런데 Jenkins Credentials에 저장된 프로파일을 가져오는 과정에서 경로를 인식하지 못하는 에러가 발생
  - 이유는 jenkins에서 item 명칭을 9to6 pipeline으로 공백을 포함시켰는데 해당 부분이 문제가 됨 -> jenkinsfile 내에서 Credentials를 가져오는 환경 변수를 따옴표로 감싸서 해결함 (jenkins 소스코드 보안 관리 방법.md 파일 참고) 

### 2. Jenkins 권한 문제 

- **사실 Jenkins 권한에 관한 문제는 컨테이너 실행 시 -u root 옵션으로 root 계정으로 실행하면 다 해결됨 -> 잘 모르기도 했고, 보안에 조금 더 신경쓰고 싶어서 필요한 권한을 찾아서 풀어주는 방식으로 해결함**

- 상황 1 

  - Jenkins Credentials에 저장된 properties 파일을 spring 프로젝트의 resources 경로에 복사(cp)하는 과정에서 권한 에러가 발생
  - **EC2 인스턴스 내에서 Jenkins가 파일을 수정하는 권한이 없어서 발생**

  - resuorce 폴더에 수정 권한을 부여해서 해결함 
    - `sh 'chmod -R 755 simcheonge_server/src/main/resources/'`

- 상황 2

  - jenkins를 도커 컨테이너로 실행시켰는데 jenkinsfile에서 docker 명령어로 실행하려면 docker는 jenkins 밖에 설치되어 있으므로 docker 명령어를 인식을 못함

  -  jenkins가 외부의 호스트의 데몬을 이용할 수 있도록 jenkins 컨테이너 실행 시 `-v /var/run/docker.sock:/var/run/docker.sock \` `-v $(which docker):/usr/bin/docker \`
    로 볼륨 마운트 옵션을 설정해 접근이 가능하도록 했음

  - 접근은 가능한데 이제, jenkins 컨테이너 내부에서는 jenkins 계정으로 작업을 수행하는데 jenkins 계정은 docker 명령을 수행할 권한이 없음. /var/run/docker.sock 이 root 계정에만 실행 권한을 갖기 때문

  - ```bash
    # Host에서 입력
    $ docker exec -it -u root ${jenkins-container-name} /bin/bash
    
    #컨테이너 내부(root) 에서 입력
    $ chown jenkins:jenkins /var/run/docker.sock
    ```

  - 위 명령어를 통해 권한을 풀어주어 해결


### 3. apk 파일의 버전관리

- apk파일이 저장되는 폴더를 두 개 두기 
  - 하나는 유저가 다운받는 최신파일용 (항상 최신파일만 들어가도록)
  - 다른 하나는 apk파일명 뒤에 버전명이 붙는 버전관리가 되는 폴더