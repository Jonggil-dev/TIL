# AWS S3 권한 설정과 버킷 생성

- ### 참고

  - [S3 생성 과정](https://celdan.tistory.com/36)
  - [기본 암호화 설정 설명](https://choiblog.tistory.com/187)
  - [ACL 설명](https://sinclairstudio.tistory.com/477)
  - [Public Access, ACL, Bucket 정책 권한 설명](https://real-dongsoo7.tistory.com/101)

---

### 1. S3

- `Simple Storage Service`의 줄임말로 AWS(Amazon Web Service)에서 제공하는 **파일 저장 공간 서비스**



### 2. 용어

1. **객체 : 이미지나 동영상 같은 파일**
2. **버킷 : 객체를 저장하는 공간**



### 3. 퍼블릭 엑세스 설정vs ACL vs Bucket Policy(정책) 정리

1. **퍼블릭 엑세스 설정**
   - 퍼블릭 액세스 권한은 말 그대로 모두에게 액세스 권한을 오픈할 것인지 아니면 임의의 사용자에게는 접근 권한을 제한할 것인지 설정.
   - 퍼블릭 액세스에는 총 4종류의 접근 제한이 있음


2. **ACL (Access Control List)**

   - 버킷이나 객체에 대해 요청자의 권한 허용 범위를 어디까지 허용할 것인가에 대해 설정하는 접근 제어 목록
     - ACL을 설정할 때 특정 AWS 계정 ID를 사용하여 그 계정에 대해 읽기, 쓰기, 삭제 등의 권한을 명시적으로 부여할 수 있음. 이렇게 설정된 권한은 해당 계정이 소유하는 AWS 자원(예: EC2 인스턴스, 람다 함수 등)이 버킷이나 객체에 접근할 때 적용됨

   - 위에서 모든 퍼블릭 액세스에 대해서 차단 했다면 ACL에서 퍼블릭에 대한 권한을 설정하여도 변경되지 않음

   - 쉽게 설명해서 파티 초대장 리스트 같은 것이라 생각할 수 있다. 예를 들어 파티를 할때 초대장을 지인들에게 나누어 주는데 초대장을 받은 사람은 파티에 들어올 수 있고, 받지 못한 사람은 들어올 수 없도록 하는 것이다. 초대 받은사람인지 아닌지를 확인하기 위해 만들어진 초청자 목록이 있는데 이 목록이 바로 ACL이라고 할 수 있다.
   
   
   > 참고
   >
   > **버킷과 개별 객체들의 권한은 독립적임**. 객체는 객체가 속한 버킷으로부터 권한을 상속받지 않음.
   > 예를 들어, 폴더를 생성했을 때 폴더에 ACL를 퍼블릭으로 설정했다고 한다. 이미 폴더에 담겨져 있는 객체의 경우 퍼블릭 설정이 될 것이다. 그런데 이 상태에서 새로운 객체를 폴더에 업로드하면, **새로운 객체는 폴더 (디렉토리)의 권한을 상속받지 않기 때문에 퍼블릭 설정이 적용되지 않음**


3. **Bucket Policy(정책 설정)**

   - 버킷을 사용할 권한을 가진 여러 명의 사용자 별로 각각의 행위에 대한 권한 범위를 설정할 수 있습니다. 누군가는 읽기만 가능하고 누군가는 읽기, 쓰기 모두 가능한 상태 같이 말이죠, Bucket에 대한 설정은 Bucket Policy를 통해 설정합니다. 버킷 정책 또한 퍼블릭 액세스 설정에 따라 퍼블릭에 대한 액세스 권한을 오픈하더라도 무시되기도 합니다.

   

### 4. 생성방법

- AWS S3 접속
- 버킷 생성

  1. 버킷 이름과 리전

     - 버킷 이름은 유일해야 함 (다른 사용자가 쓰고 있는 이름은 불가)

     - 버킷 이름과 버킷 리전은 변경 불가능함
2. 객체 소유권
     - **생성하려는 버킷(객체 포함)에 대해 모든 권한을 현재 AWS 계정만 줄 것인지, 아니면 다른 사용자(AWS 계정 등)에게도 동일한 권한을 줄것인지 설정하는 것**
   - **ACL 활성화 됨+ 객체 소유권 : 버킷 소유자 선호 체크**
     - ACL 비활성화됨 하면 Spring으로 이미지 업로드 할 때 The bucket does not allow ACL`이 발생함.
     - **그런데, ACL 비활성화하고 접근 가능하게 하는 방법이 잊지 않을까? (보안 측면에서 좋아 보임)**
       **-> 시간 날 때 찾아보기**
  3. 퍼블릭 엑세스 설정
  
     - **버킷에 저장된 데이터를 외부 인터넷 사용자에게 공개할지 여부를 결정하는 설정**
     - **현재 프로젝트에서는 프로필 이미지 제공을 위해 클라이언트, 백엔드 서버가 객체에 접근이 가능해야 하므로 모든 퍼블릭 엑세스를 허용함. 객체가 인터넷을 통해 접근 가능하도록 한다는 의미**
4. 버전 관리
  
   - 버킷에 저장된 각 객체의 개별적인 업데이트와 삭제를 추적하여, 객체의 이전 버전을 보관하고 관리할 수 있게 해주는 옵션
     - **추가 비용이 드는 작업이므로 필요한 경우가 아니라면 비활성화**
  5. 태그 설정

     - 태그를 추가하면 스토리지를 분류하는데 도움이 됨
   - 필요하다면 설정하기
  6. 기본 암호화 설정

   - 객체가 저장될 때 암호화 되도록 하게 하는 설정
     - default 선택사항으로 진행 (SSE-S3, 버킷 키 활성화)
7. 버킷 정책 수정 (버킷 클릭 -> 권한 탭-> 버킷 정책 편집)
     - 버킷 ARN을 복사한 후, 정책 생성기 클릭
     - 생성할 정책 설정
     - Select Type of Policy : S3 Bucket Policy
       - Effect : allow
     - Principal : * 입력
       - Actions : Get Object, Put Object 체크
       - Amazon Resource Name (ARN) : 복사한 ARN + /* 입력
         `(ex)arn:aws:s3:::air-planning/*`
     - Add Statement 클릭
     - Generate Policy 클릭 후 JSON 구문 복사
     - 정책 편집 페이지로 복귀하여 복사한 JSON 구문 붙여넣기 후 변경사항 저장 클릭
8. 버킷 생성 및 설정 완료
     - 위의 방법으로 생성된 버킷의 경우 모두에게 공개된 상태로 보안에 취약한 상태이므로,
     상황에 맞게 퍼블릭 엑세스, ACL, Bucket Policy를 추가 설정하여 접근 권한 설정하기
